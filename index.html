<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Haber Y√∂netim Sistemi</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #F7F8FA; --surface: #ffffff; --border: #E8ECF0; --border-soft: #F1F5F9;
    --text: #0F172A; --text-mid: #475569; --text-soft: #94A3B8;
    --blue: #1A56DB; --blue-bg: #EFF6FF; --blue-border: #BFDBFE;
    --red: #EF4444; --red-bg: #FEF2F2; --red-border: #FECACA;
    --green: #10B981; --green-bg: #ECFDF5; --green-border: #A7F3D0;
    --amber: #F59E0B; --amber-bg: #FFFBEB; --amber-border: #FDE68A;
    --slate: #64748B;
    --radius-lg: 16px; --shadow: 0 4px 20px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
  }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }
  ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }

  #loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--blue); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .header { background: var(--surface); border-bottom: 1.5px solid var(--border-soft); position: sticky; top: 0; z-index: 200; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
  .header-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 28px; height: 64px; }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon { width: 38px; height: 38px; background: var(--blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 19px; }
  .logo-text { font-family: 'DM Serif Display', serif; font-size: 19px; letter-spacing: -0.3px; }
  .logo-sub { font-size: 11px; color: var(--text-soft); font-weight: 500; }
  .sync-label { font-size: 12px; color: var(--text-soft); display: flex; align-items: center; gap: 6px; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }

  .btn { display: inline-flex; align-items: center; gap: 6px; border: none; border-radius: 10px; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s; padding: 9px 18px; }
  .btn-primary { background: var(--blue); color: #fff; } .btn-primary:hover { background: #1447C0; }
  .btn-success { background: var(--green); color: #fff; } .btn-success:hover { background: #059669; }
  .btn-danger  { background: var(--red-bg); color: var(--red); border: 1.5px solid var(--red-border); } .btn-danger:hover { background: #FEE2E2; }
  .btn-ghost   { background: transparent; color: var(--text-mid); border: 1.5px solid var(--border); } .btn-ghost:hover { background: var(--border-soft); }

  .container { max-width: 1100px; margin: 0 auto; padding: 28px 24px; }

  .alert { border-radius: 10px; padding: 11px 16px; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .alert-amber { background: var(--amber-bg); border: 1.5px solid var(--amber-border); color: #92400E; }
  .alert-blue  { background: var(--blue-bg);  border: 1.5px solid var(--blue-border);  color: #1E40AF; }

  .stats { display: flex; gap: 14px; margin-bottom: 24px; flex-wrap: wrap; }
  .stat-card { background: var(--surface); border-radius: var(--radius-lg); padding: 18px 22px; border: 1.5px solid var(--border-soft); flex: 1; min-width: 110px; }
  .stat-num { font-size: 26px; font-weight: 700; line-height: 1; }
  .stat-lbl { font-size: 12px; color: var(--text-soft); font-weight: 500; margin-top: 3px; }

  .filter-bar { background: var(--surface); border-radius: var(--radius-lg); padding: 14px 18px; border: 1.5px solid var(--border-soft); margin-bottom: 18px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .search-input { padding: 9px 14px; border: 1.5px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 13px; color: var(--text); background: var(--bg); width: 220px; outline: none; transition: border-color .15s; }
  .search-input:focus { border-color: var(--blue); background: #fff; }
  .chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .chip { padding: 5px 13px; border-radius: 20px; border: 1.5px solid var(--border); font-size: 12px; font-weight: 500; cursor: pointer; background: #fff; color: var(--text-mid); transition: all .15s; white-space: nowrap; }
  .chip:hover { background: var(--border-soft); }
  .chip.active        { background: var(--blue);  color: #fff; border-color: var(--blue);  }
  .chip.red           { border-color: var(--red-border);   color: var(--red);   }
  .chip.blue          { border-color: var(--blue-border);  color: var(--blue);  }
  .chip.green         { border-color: var(--green-border); color: var(--green); }
  .chip.red.active    { background: var(--red);   border-color: var(--red);   color: #fff; }
  .chip.blue.active   { background: var(--blue);  border-color: var(--blue);  color: #fff; }
  .chip.green.active  { background: var(--green); border-color: var(--green); color: #fff; }
  .divider { width: 1px; height: 28px; background: var(--border); flex-shrink: 0; }

  .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 14px; }
  .news-card { background: var(--surface); border-radius: var(--radius-lg); padding: 18px 20px; border: 1.5px solid var(--border-soft); cursor: pointer; transition: all .18s; position: relative; border-left-width: 4px; }
  .news-card:hover { border-color: #CBD5E1; box-shadow: var(--shadow); transform: translateY(-2px); }
  .card-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 11px; }
  .loc-badge { font-size: 12px; font-weight: 700; color: var(--blue); background: var(--blue-bg); padding: 3px 11px; border-radius: 20px; }
  .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 11px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1.5px solid; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; }
  .priority-badge { position: absolute; top: -7px; right: 14px; background: var(--amber); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 10px; border-radius: 20px; }
  .card-title  { font-size: 15px; font-weight: 700; color: var(--text); line-height: 1.35; margin-bottom: 5px; }
  .card-doctor { font-size: 13px; color: var(--text-mid); font-weight: 500; margin-bottom: 8px; }
  .card-bolum  { display: inline-flex; align-items: center; gap: 5px; background: #F1F5F9; border-radius: 20px; padding: 3px 10px; margin-bottom: 10px; }
  .bolum-label { font-size: 10px; font-weight: 700; color: var(--slate); letter-spacing: 0.4px; }
  .bolum-val   { font-size: 11px; font-weight: 600; color: #334155; }
  .card-dates  { display: flex; gap: 14px; font-size: 12px; color: var(--text-soft); flex-wrap: wrap; }

  .empty { text-align: center; padding: 64px 20px; color: var(--text-soft); }
  .empty-icon  { font-size: 42px; margin-bottom: 12px; }
  .empty-title { font-size: 16px; font-weight: 600; color: var(--text-mid); margin-bottom: 6px; }

  .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.45); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeOv .2s ease; }
  @keyframes fadeOv { from{opacity:0} to{opacity:1} }
  .modal { background: var(--surface); border-radius: 20px; width: 100%; max-width: 620px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); animation: slideMd .22s ease; }
  @keyframes slideMd { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
  .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 28px 20px; border-bottom: 1.5px solid var(--border-soft); position: sticky; top: 0; background: #fff; border-radius: 20px 20px 0 0; z-index: 1; }
  .modal-title  { font-family: 'DM Serif Display', serif; font-size: 20px; }
  .modal-body   { padding: 24px 28px; }
  .modal-footer { padding: 16px 28px 24px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1.5px solid var(--border-soft); }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-full  { grid-column: 1 / -1; }
  .form-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-soft); margin-bottom: 6px; letter-spacing: 0.4px; }
  .form-control { width: 100%; padding: 10px 13px; border: 1.5px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 13px; color: var(--text); background: var(--bg); outline: none; transition: border-color .15s; }
  .form-control:focus { border-color: var(--blue); background: #fff; }
  textarea.form-control { resize: vertical; min-height: 72px; }
  .checkbox-row { display: flex; align-items: center; gap: 9px; cursor: pointer; }
  .checkbox-row input { width: 16px; height: 16px; accent-color: var(--amber); cursor: pointer; }
  .checkbox-row span { font-size: 13px; font-weight: 500; color: var(--text-mid); }

  .detail-status-bar { border-left: 5px solid; padding-left: 18px; margin-bottom: 22px; }
  .detail-chips { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
  .detail-main-title { font-family: 'DM Serif Display', serif; font-size: 22px; line-height: 1.3; }
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .detail-field { background: var(--bg); border-radius: 11px; padding: 13px 15px; }
  .detail-field-lbl { font-size: 10px; font-weight: 700; color: var(--text-soft); letter-spacing: 0.5px; margin-bottom: 5px; }
  .detail-field-val { font-size: 14px; font-weight: 600; }
  .notes-box { background: var(--amber-bg); border: 1.5px solid var(--amber-border); border-radius: 11px; padding: 13px 15px; }
  .notes-lbl { font-size: 10px; font-weight: 700; color: #D97706; letter-spacing: 0.5px; margin-bottom: 5px; }
  .notes-val { font-size: 13px; color: var(--text-mid); line-height: 1.6; }
  .detail-meta { font-size: 11px; color: #CBD5E1; text-align: right; margin-top: 14px; }
  .detail-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  .toast { position: fixed; bottom: 24px; right: 24px; z-index: 9999; padding: 12px 20px; border-radius: 12px; font-size: 13px; font-weight: 600; box-shadow: 0 8px 28px rgba(0,0,0,0.16); border: 1.5px solid; animation: toastIn .25s ease; }
  @keyframes toastIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
  .toast-success { background: var(--green-bg); color: #065F46; border-color: var(--green-border); }
  .toast-error   { background: var(--red-bg);   color: #991B1B; border-color: var(--red-border); }

  .fade-in { animation: fadeIn .22s ease; }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  /* TAB NAV */
  .tab-nav { display: flex; gap: 4px; background: var(--border-soft); border-radius: 12px; padding: 4px; }
  .tab-btn { padding: 8px 20px; border-radius: 9px; border: none; background: transparent; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; color: var(--text-soft); transition: all .15s; }
  .tab-btn.active { background: #fff; color: var(--blue); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .tab-btn:hover:not(.active) { color: var(--text-mid); }

  /* REPORT */
  .report-section { display: none; }
  .report-section.active { display: block; }
  .report-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 22px; flex-wrap: wrap; gap: 12px; }
  .report-title { font-family: 'DM Serif Display', serif; font-size: 22px; }
  .period-select { padding: 8px 13px; border: 1.5px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 13px; color: var(--text); background: var(--bg); outline: none; cursor: pointer; }
  .period-select:focus { border-color: var(--blue); }

  .total-report-bar { background: var(--surface); border-radius: var(--radius-lg); padding: 20px 22px; border: 1.5px solid var(--border-soft); margin-bottom: 20px; }
  .report-card-title { font-size: 12px; font-weight: 700; color: var(--text-soft); margin-bottom: 16px; letter-spacing: 0.4px; }
  .total-bar-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .total-bar-label { font-size: 13px; font-weight: 600; color: var(--text-mid); width: 110px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .total-bar-track { flex: 1; height: 10px; background: var(--border-soft); border-radius: 10px; overflow: hidden; }
  .total-bar-fill  { height: 100%; background: var(--green); border-radius: 10px; transition: width .7s ease; }
  .total-bar-num   { font-size: 13px; font-weight: 700; color: var(--green); width: 24px; text-align: right; }

  .report-two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
  .summary-card { background: var(--surface); border-radius: var(--radius-lg); padding: 20px 22px; border: 1.5px solid var(--border-soft); }
  .rank-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border-soft); }
  .rank-row:last-child { border-bottom: none; }
  .rank-num  { font-size: 11px; font-weight: 700; color: var(--text-soft); width: 18px; }
  .rank-name { flex: 1; font-size: 13px; font-weight: 600; color: var(--text); }
  .rank-count { font-size: 13px; font-weight: 700; }

  .loc-detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
  .loc-detail-card { background: var(--surface); border-radius: var(--radius-lg); padding: 18px 20px; border: 1.5px solid var(--border-soft); border-left: 4px solid var(--green); }
  .loc-detail-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .loc-detail-name { font-size: 14px; font-weight: 700; }
  .loc-detail-total { background: var(--green-bg); color: var(--green); font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 20px; }
  .mini-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .mini-bar-label { font-size: 11px; color: var(--text-soft); width: 58px; flex-shrink: 0; font-weight: 500; }
  .mini-bar-track { flex: 1; height: 6px; background: var(--border-soft); border-radius: 6px; overflow: hidden; }
  .mini-bar-fill  { height: 100%; border-radius: 6px; }
  .mini-bar-num   { font-size: 11px; font-weight: 700; width: 16px; text-align: right; }

  /* MULTI INPUT */
  .multi-input-container { display: flex; flex-direction: column; gap: 8px; }
  .multi-input-row { display: flex; gap: 8px; align-items: flex-start; }
  .multi-input-row .form-control { flex: 1; }
  .multi-input-row select.form-control { width: 140px; flex-shrink: 0; }
  .btn-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; padding: 0; border-radius: 8px; flex-shrink: 0; font-size: 16px; }
  .btn-add { background: var(--green-bg); color: var(--green); border: 1.5px solid var(--green-border); }
  .btn-add:hover { background: var(--green); color: #fff; }
  .btn-remove { background: var(--red-bg); color: var(--red); border: 1.5px solid var(--red-border); }
  .btn-remove:hover { background: var(--red); color: #fff; }

  /* EXPORT BUTTON */
  .btn-export { background: var(--green); color: #fff; display: inline-flex; align-items: center; gap: 6px; }
  .btn-export:hover { background: #059669; }

  @media (max-width: 640px) {
    .form-grid,.detail-grid,.report-two-col { grid-template-columns: 1fr; }
    .header-inner { padding: 0 16px; }
    .container { padding: 18px 14px; }
    .search-input { width: 100%; }
    .tab-btn { padding: 7px 12px; font-size: 12px; }
  }

  /* LOGIN SCREEN */
  #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .login-card { background: white; border-radius: 20px; padding: 40px; max-width: 420px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
  .login-header { text-align: center; margin-bottom: 32px; }
  .login-logo { width: 60px; height: 60px; background: var(--blue); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; margin: 0 auto 16px; }
  .login-title { font-family: 'DM Serif Display', serif; font-size: 24px; color: var(--text); margin-bottom: 6px; }
  .login-subtitle { font-size: 14px; color: var(--text-soft); }
  .login-form { display: flex; flex-direction: column; gap: 16px; }
  .login-input { padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 14px; font-family: inherit; transition: border-color .15s; }
  .login-input:focus { outline: none; border-color: var(--blue); }
  .login-btn { background: var(--blue); color: white; border: none; padding: 13px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: inherit; transition: background .15s; }
  .login-btn:hover { background: #1447C0; }
  .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }
  .login-error { background: var(--red-bg); color: var(--red); padding: 10px 14px; border-radius: 10px; font-size: 13px; text-align: center; border: 1.5px solid var(--red-border); }
  .user-badge { display: flex; align-items: center; gap: 8px; background: var(--blue-bg); padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--blue); }
  .user-initial { width: 24px; height: 24px; background: var(--blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-header">
      <div class="login-logo">üì∞</div>
      <div class="login-title">Haber Y√∂netim Sistemi</div>
      <div class="login-subtitle">Hastane Medya Ekibi</div>
    </div>
    <div class="login-form">
      <div id="login-error" class="login-error" style="display:none"></div>
      <input type="text" id="login-name" class="login-input" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z" autocomplete="name" />
      <button id="login-btn" class="login-btn">Ba≈üla</button>
      <div style="text-align:center;font-size:12px;color:var(--text-soft);margin-top:8px">
        Kim olduƒüunuzu belirtmek i√ßin sadece adƒ±nƒ±zƒ± yazƒ±n
      </div>
    </div>
  </div>
</div>

<div id="loading-screen">
  <div style="width:42px;height:42px;background:var(--blue);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:22px">üì∞</div>
  <div class="spinner"></div>
  <div style="color:var(--text-soft);font-size:14px;font-weight:500">Haberler y√ºkleniyor‚Ä¶</div>
</div>

<div class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">üì∞</div>
      <div>
        <div class="logo-text">Haber Y√∂netim Sistemi</div>
        <div class="logo-sub">Hastane Medya Ekibi</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:14px">
      <div class="tab-nav">
        <button class="tab-btn active" id="tab-haberler" onclick="switchTab('haberler')">üìã Haberler</button>
        <button class="tab-btn" id="tab-rapor" onclick="switchTab('rapor')">üìä Rapor</button>
      </div>
      <span class="sync-label"><span class="sync-dot" id="sync-dot"></span><span id="sync-label">Baƒülanƒ±yor‚Ä¶</span></span>
      <div class="user-badge" id="user-badge">
        <div class="user-initial" id="user-initial">?</div>
        <span id="user-name">Kullanƒ±cƒ±</span>
        <button id="logout-btn" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:18px;padding:0;line-height:1">√ó</button>
      </div>
      <button class="btn btn-primary" id="btn-haber-ekle" onclick="openAddModal()">+ Haber Ekle</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- HABERLER TAB -->
  <div id="view-haberler">
  <div id="alerts-section"></div>
  <div class="stats" id="stats-section"></div>
  <div class="filter-bar">
    <input class="search-input" type="text" id="search-input" placeholder="üîç Doktor, ba≈ülƒ±k veya b√∂l√ºm ara‚Ä¶" oninput="renderList()" />
    <div class="divider"></div>
    <div class="chips" id="loc-chips"></div>
    <div class="divider"></div>
    <div class="chips" id="status-chips"></div>
  </div>
  <div id="news-grid"></div>
  </div>

  <!-- RAPOR TAB -->
  <div id="view-rapor" style="display:none">
    <div class="report-header">
      <div class="report-title">üìä Yayƒ±n Raporu</div>
      <div style="display:flex;gap:10px;align-items:center">
        <select class="period-select" id="period-select" onchange="renderReport()">
          <option value="all">T√ºm Zamanlar</option>
          <option value="thismonth">Bu Ay</option>
          <option value="lastmonth">Ge√ßen Ay</option>
          <option value="thisyear">Bu Yƒ±l</option>
        </select>
        <button class="btn btn-export" onclick="exportReport()">üì• Excel ƒ∞ndir</button>
      </div>
    </div>
    <div id="report-content"></div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="overlay" id="form-modal" style="display:none" onclick="handleOverlayClick(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Yeni Haber Ekle</div>
      <button class="btn btn-ghost" onclick="closeModal('form-modal')">‚úï Kapat</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group form-full">
          <label>LOKASYONLAR * <span style="font-weight:400;color:var(--text-soft)">(birden fazla ekleyebilirsiniz)</span></label>
          <div class="multi-input-container" id="locations-container">
            <div class="multi-input-row">
              <select class="form-control location-input"><option value="">Se√ßiniz‚Ä¶</option></select>
              <button type="button" class="btn btn-icon btn-add" onclick="addLocationRow()">+</button>
            </div>
          </div>
        </div>
        <div class="form-group"><label>B√ñL√úM</label><select class="form-control" id="f-topic" onchange="handleTopicChange()"><option value="">Se√ßiniz‚Ä¶</option></select></div>
        <div class="form-group form-full" id="custom-topic-wrap" style="display:none"><label>√ñZEL B√ñL√úM</label><input class="form-control" id="f-custom-topic" placeholder="B√∂l√ºm√º yazƒ±n‚Ä¶" /></div>
        <div class="form-group form-full"><label>HABER BA≈ûLIƒûI *</label><input class="form-control" id="f-title" placeholder="Haberin ba≈ülƒ±ƒüƒ±nƒ± yazƒ±n‚Ä¶" /></div>
        <div class="form-group form-full">
          <label>DOKTORLAR * <span style="font-weight:400;color:var(--text-soft)">(birden fazla ekleyebilirsiniz)</span></label>
          <div class="multi-input-container" id="doctors-container">
            <div class="multi-input-row">
              <input class="form-control doctor-input" placeholder="Prof. Dr. Ad Soyad‚Ä¶" />
              <button type="button" class="btn btn-icon btn-add" onclick="addDoctorRow()">+</button>
            </div>
          </div>
        </div>
        <div class="form-group"><label>√áEKƒ∞M TARƒ∞Hƒ∞ *</label><input class="form-control" type="date" id="f-shoot-date" /></div>
        <div class="form-group"><label>DURUM</label>
          <select class="form-control" id="f-status">
            <option value="waiting">üî¥ Payla≈üƒ±mƒ± Bekleniyor</option>
            <option value="scheduled">üîµ Planlandƒ±</option>
            <option value="published">üü¢ Payla≈üƒ±ldƒ±</option>
          </select>
        </div>
        <div class="form-group form-full"><label>PAYLA≈ûIM TARƒ∞Hƒ∞ <span style="font-weight:400;color:var(--text-soft)">(girilince otomatik Planlandƒ± olur)</span></label><input class="form-control" type="date" id="f-publish-date" onchange="autoStatus()" /></div>
        <div class="form-group form-full"><label>HABER Lƒ∞NKƒ∞ <span style="font-weight:400;color:var(--text-soft)">(payla≈üƒ±lan haberin sosyal medya veya web linki)</span></label><input class="form-control" type="url" id="f-link" placeholder="https://‚Ä¶" /></div>
        <div class="form-group form-full"><label>NOTLAR / √ñNEMLƒ∞ G√úNLER</label><textarea class="form-control" id="f-notes" placeholder="A√ßƒ±klamalar, √∂nemli g√ºnler, hatƒ±rlatmalar‚Ä¶"></textarea></div>
        <div class="form-group form-full"><label class="checkbox-row"><input type="checkbox" id="f-priority" /><span>‚≠ê √ñncelikli haber olarak i≈üaretle</span></label></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('form-modal')">ƒ∞ptal</button>
      <button class="btn btn-primary" id="submit-btn" onclick="handleSubmit()">‚úÖ Kaydet</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="overlay" id="detail-modal" style="display:none" onclick="handleOverlayClick(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="detail-actions" id="detail-actions"></div>
      <button class="btn btn-ghost" onclick="closeModal('detail-modal')">‚úï Kapat</button>
    </div>
    <div class="modal-body" id="detail-body"></div>
  </div>
</div>

<!-- DELETE CONFIRM -->
<div class="overlay" id="delete-modal" style="display:none" onclick="handleOverlayClick(event)">
  <div class="modal" style="max-width:400px" onclick="event.stopPropagation()">
    <div class="modal-header"><div class="modal-title">Haberi Sil</div><button class="btn btn-ghost" onclick="closeModal('delete-modal')">‚úï</button></div>
    <div class="modal-body"><p style="color:var(--text-mid);line-height:1.6">Bu haberi silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.</p></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('delete-modal')">ƒ∞ptal</button>
      <button class="btn btn-danger" id="confirm-delete-btn">üóë Evet, Sil</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, query, orderBy }
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut }
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1ZuYFHRvvzLGS8OQBEkByJCBpn41WX0s",
  authDomain: "haberler-42f64.firebaseapp.com",
  projectId: "haberler-42f64",
  storageBucket: "haberler-42f64.firebasestorage.app",
  messagingSenderId: "902830397579",
  appId: "1:902830397579:web:057dc3daa2d53107801c8e",
  measurementId: "G-XW8M57R7FR"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
const col = collection(db, "haberler");

let currentUser = null;

// SIMPLE AUTH WITHOUT FIREBASE
function checkLocalAuth() {
  const userName = localStorage.getItem("haber_user_name");
  if (userName) {
    currentUser = { name: userName };
    showApp(userName);
  } else {
    document.getElementById("login-screen").style.display = "flex";
    document.getElementById("loading-screen").style.display = "none";
  }
}

function showApp(name) {
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("loading-screen").style.display = "none";
  const initial = name.charAt(0).toUpperCase();
  document.getElementById("user-name").textContent = name;
  document.getElementById("user-initial").textContent = initial;
  initSelects();
  startListener();
}

async function handleLogin() {
  const name = document.getElementById("login-name").value.trim();
  const errDiv = document.getElementById("login-error");
  
  if (!name || name.length < 2) {
    errDiv.textContent = "L√ºtfen adƒ±nƒ±zƒ± yazƒ±n (en az 2 karakter)";
    errDiv.style.display = "block";
    return;
  }
  
  localStorage.setItem("haber_user_name", name);
  currentUser = { name };
  errDiv.style.display = "none";
  showApp(name);
}

async function handleLogout() {
  if (confirm("√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?")) {
    localStorage.removeItem("haber_user_name");
    location.reload();
  }
}

const LOCATIONS = ["Mega","Acƒ±badem","Bah√ßelievler","Ko≈üuyolu","Pendik","√áamlƒ±ca","Vatan","Unkapanƒ±","Esenler","Sefak√∂y"];
const TOPICS = [
  "Kalp Damar Cerrahisi","Kardiyoloji","Kalp Damar Hastalƒ±klarƒ±",
  "Onkoloji (Tƒ±bbi Onkoloji)","√áocuk Onkolojisi","Radyasyon Onkolojisi",
  "Ortopedi ve Travmatoloji","Beyin ve Sinir Cerrahisi","Genel Cerrahi",
  "√úroloji","Kadƒ±n Hastalƒ±klarƒ± ve Doƒüum","Kulak Burun Boƒüaz (KBB)",
  "G√∂z Hastalƒ±klarƒ±","Di≈ü Hekimliƒüi","Aƒüƒ±z Di≈ü ve √áene Cerrahisi",
  "√áocuk Saƒülƒ±ƒüƒ± ve Hastalƒ±klarƒ±","Yenidoƒüan","√áocuk Cerrahisi",
  "N√∂roloji (Beyin ve Sinir Hastalƒ±klarƒ±)","Dahiliye (ƒ∞√ß Hastalƒ±klarƒ±)",
  "Endokrinoloji ve Metabolizma","Gastroenteroloji","Hematoloji",
  "Enfeksiyon Hastalƒ±klarƒ±","G√∂ƒü√ºs Hastalƒ±klarƒ±","Allerji ve ƒ∞mm√ºnoloji",
  "Fiziksel Tƒ±p ve Rehabilitasyon","Romatolo ji","Dermatoloji (Cildiye)",
  "Plastik Rekons tr√ºktif ve Estetik Cerrahi","Anestezi ve Reanimasyon",
  "Radyoloji","N√ºkleer Tƒ±p","Patoloji",
  "Tƒ±bbi Biyokimya","Tƒ±bbi Mikrobiyoloji","Beslenme ve Diyet",
  "Fizik Tedavi","Psikoloji","Psikiyatri",
  "G√∂ƒü√ºs Cerrahisi","Periferik Damar Cerrahisi",
  "Tƒ±bbi Genetik","Check-Up","Aile Hekimliƒüi","Diƒüer"
];
const STATUS    = {
  waiting:   { label:"Payla≈üƒ±mƒ± Bekleniyor", color:"#EF4444", bg:"#FEF2F2", border:"#FECACA" },
  scheduled: { label:"Planlandƒ±",            color:"#1A56DB", bg:"#EFF6FF", border:"#BFDBFE" },
  published: { label:"Payla≈üƒ±ldƒ±",           color:"#10B981", bg:"#ECFDF5", border:"#A7F3D0" },
};

let news = [], filterLoc = "T√ºm√º", filterStatus = "T√ºm√º", editingId = null, openDetailId = null;

// HELPERS
const fmtDate = d => { if (!d) return "‚Äî"; const [y,m,dd]=d.split("-"); return `${dd}.${m}.${y}`; };
const todayStr    = () => new Date().toISOString().split("T")[0];
const tomorrowStr = () => { const t=new Date(); t.setDate(t.getDate()+1); return t.toISOString().split("T")[0]; };
const isToday    = d => d === todayStr();
const isTomorrow = d => d === tomorrowStr();

// XSS PROTECTION
const escapeHtml = (text) => {
  if (!text) return "";
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
};

// TOAST
window.showToast = (msg, type="success") => {
  const el = document.createElement("div");
  el.className = `toast toast-${type}`;
  el.textContent = (type==="success"?"‚úÖ ":"‚ùå ") + msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2800);
};

// SELECTS
function initSelects() {
  // Populate all location dropdowns
  document.querySelectorAll(".location-input").forEach(sel => {
    sel.innerHTML = '<option value="">Se√ßiniz‚Ä¶</option>' + LOCATIONS.map(l => `<option value="${l}">${l}</option>`).join("");
  });
  // Populate topic dropdown
  const ts = document.getElementById("f-topic");
  ts.innerHTML = '<option value="">Se√ßiniz‚Ä¶</option>' + TOPICS.map(t => `<option value="${t}">${t}</option>`).join("");
}

// MULTI LOCATION
window.addLocationRow = () => {
  const container = document.getElementById("locations-container");
  const row = document.createElement("div");
  row.className = "multi-input-row";
  row.innerHTML = `
    <select class="form-control location-input"><option value="">Se√ßiniz‚Ä¶</option>${LOCATIONS.map(l=>`<option value="${l}">${l}</option>`).join("")}</select>
    <button type="button" class="btn btn-icon btn-remove" onclick="this.parentElement.remove()">‚àí</button>`;
  container.appendChild(row);
};

// MULTI DOCTOR
window.addDoctorRow = () => {
  const container = document.getElementById("doctors-container");
  const row = document.createElement("div");
  row.className = "multi-input-row";
  row.innerHTML = `
    <input class="form-control doctor-input" placeholder="Prof. Dr. Ad Soyad‚Ä¶" />
    <button type="button" class="btn btn-icon btn-remove" onclick="this.parentElement.remove()">‚àí</button>`;
  container.appendChild(row);
};

// REAL-TIME
function startListener() {
  onSnapshot(query(col, orderBy("createdAt","desc")), snap => {
    news = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    document.getElementById("loading-screen").style.display = "none";
    document.getElementById("sync-dot").style.background   = "var(--green)";
    document.getElementById("sync-label").textContent      = "Canlƒ±";
    renderAll();
    if (openDetailId && document.getElementById("detail-modal").style.display !== "none") openDetail(openDetailId);
  }, () => {
    document.getElementById("sync-dot").style.background = "var(--red)";
    document.getElementById("sync-label").textContent    = "Baƒülantƒ± yok";
  });
}

// CRUD
const addNews = data => addDoc(col, {
  ...data,
  createdBy: currentUser?.name || "Bilinmeyen",
  createdAt: serverTimestamp(),
  updatedAt: serverTimestamp(),
  updatedBy: currentUser?.name || "Bilinmeyen"
});
const updateNews = (id, data) => updateDoc(doc(db, "haberler", id), {
  ...data,
  updatedAt: serverTimestamp(),
  updatedBy: currentUser?.name || "Bilinmeyen"
});
window.deleteItem = async id => {
  await deleteDoc(doc(db, "haberler", id));
  closeModal("delete-modal");
  showToast("Haber silindi.", "error");
};
window.publishItem = async id => {
  const item = news.find(n => n.id === id);
  await updateNews(id, { status: "published", publishDate: item?.publishDate || todayStr() });
  showToast("Haber yayƒ±nlandƒ±!");
};

// CHIPS
function buildLocChips() {
  document.getElementById("loc-chips").innerHTML =
    ["T√ºm√º",...LOCATIONS].map(l =>
      `<button class="chip ${filterLoc===l?"active":""}" onclick="setLoc('${l}')">${l}</button>`).join("");
}
function buildStatusChips() {
  document.getElementById("status-chips").innerHTML =
    [{k:"T√ºm√º",label:"T√ºm Durumlar",cls:""},{k:"waiting",label:"Bekleyen",cls:"red"},{k:"scheduled",label:"Planlandƒ±",cls:"blue"},{k:"published",label:"Payla≈üƒ±ldƒ±",cls:"green"}]
    .map(s=>`<button class="chip ${s.cls} ${filterStatus===s.k?"active":""}" onclick="setSt('${s.k}')">${s.label}</button>`).join("");
}
window.setLoc = l => { filterLoc=l;    buildLocChips();    renderList(); };
window.setSt  = s => { filterStatus=s; buildStatusChips(); renderList(); };

// STATS
function renderStats() {
  const w=news.filter(n=>n.status==="waiting").length, sc=news.filter(n=>n.status==="scheduled").length, p=news.filter(n=>n.status==="published").length;
  document.getElementById("stats-section").innerHTML = `
    <div class="stat-card" style="border-left:4px solid #EF4444"><div style="font-size:20px;margin-bottom:4px">üî¥</div><div class="stat-num" style="color:#EF4444">${w}</div><div class="stat-lbl">Bekleyen</div></div>
    <div class="stat-card" style="border-left:4px solid #1A56DB"><div style="font-size:20px;margin-bottom:4px">üîµ</div><div class="stat-num" style="color:#1A56DB">${sc}</div><div class="stat-lbl">Planlandƒ±</div></div>
    <div class="stat-card" style="border-left:4px solid #10B981"><div style="font-size:20px;margin-bottom:4px">üü¢</div><div class="stat-num" style="color:#10B981">${p}</div><div class="stat-lbl">Payla≈üƒ±ldƒ±</div></div>
    <div class="stat-card" style="border-left:4px solid #8B5CF6"><div style="font-size:20px;margin-bottom:4px">üìä</div><div class="stat-num" style="color:#8B5CF6">${news.length}</div><div class="stat-lbl">Toplam</div></div>`;
}

// ALERTS
function renderAlerts() {
  const ti=news.filter(n=>isToday(n.publishDate)&&n.status!=="published");
  const tm=news.filter(n=>isTomorrow(n.publishDate)&&n.status!=="published");
  document.getElementById("alerts-section").innerHTML =
    (ti.length?`<div class="alert alert-amber">üîî <span><strong>Bug√ºn payla≈üƒ±lacak ${ti.length} haber var:</strong> ${ti.map(n=>escapeHtml(n.doctor||n.title)).join(", ")}</span></div>`:"") +
    (tm.length?`<div class="alert alert-blue" style="margin-bottom:18px">üìÖ <span><strong>Yarƒ±n payla≈üƒ±lacak ${tm.length} haber var:</strong> ${tm.map(n=>escapeHtml(n.doctor||n.title)).join(", ")}</span></div>`:"");
}

// LIST
function renderList() {
  const q = document.getElementById("search-input").value.toLowerCase();
  const filtered = news.filter(n => {
    const locOk  = filterLoc==="T√ºm√º"    || n.location===filterLoc;
    const stOk   = filterStatus==="T√ºm√º" || n.status===filterStatus;
    const srchOk = !q || [n.title,n.doctor,n.topic,n.location].some(v=>v&&v.toLowerCase().includes(q));
    return locOk&&stOk&&srchOk;
  });
  const grid = document.getElementById("news-grid");
  if (!filtered.length) {
    grid.innerHTML=`<div class="empty fade-in"><div class="empty-icon">üì≠</div><div class="empty-title">Haber bulunamadƒ±</div><p>Filtrelerinizi deƒüi≈ütirin veya yeni haber ekleyin.</p></div>`;
    return;
  }
  grid.innerHTML = `<div class="news-grid fade-in">${filtered.map(item => {
    const st=STATUS[item.status]||STATUS.waiting;
    const today=isToday(item.publishDate), tmrw=isTomorrow(item.publishDate);
    const dc=today?"#F59E0B":tmrw?"#1A56DB":"var(--text-soft)";
    const ds=today?" (Bug√ºn!)":tmrw?" (Yarƒ±n)":"";
    const locs = Array.isArray(item.locations) ? item.locations : (item.location ? [item.location] : []);
    const docs = Array.isArray(item.doctors) ? item.doctors : (item.doctor ? [item.doctor] : []);
    return `<div class="news-card" style="border-left-color:${st.color}" onclick="openDetail('${item.id}')">
      ${item.priority?`<div class="priority-badge">‚≠ê √ñNCELƒ∞KLƒ∞</div>`:""}
      <div class="card-top">
        <span class="loc-badge">üìç ${escapeHtml(locs.length>1?locs[0]+" +"+(locs.length-1):locs[0]||"‚Äî")}</span>
        <span class="status-badge" style="color:${st.color};background:${st.bg};border-color:${st.border}">
          <span class="status-dot" style="background:${st.color}"></span>${st.label}
        </span>
      </div>
      <div class="card-title">${escapeHtml(item.title)||"‚Äî"}</div>
      <div class="card-doctor">üë®‚Äç‚öïÔ∏è ${escapeHtml(docs.length>1?docs[0]+" +"+(docs.length-1)+" doktor":docs[0]||"‚Äî")}</div>
      ${item.topic?`<div class="card-bolum"><span class="bolum-label">B√ñL√úM</span><span style="font-size:10px;color:var(--text-soft)">¬∑</span><span class="bolum-val">${escapeHtml(item.topic)}</span></div>`:""}
      <div class="card-dates">
        <span>üé¨ ${fmtDate(item.shootDate)}</span>
        ${item.publishDate?`<span style="color:${dc};font-weight:${today||tmrw?700:400}">üì§ ${fmtDate(item.publishDate)}${ds}</span>`:""}
      </div>
    </div>`;
  }).join("")}</div>`;
}

// DETAIL
window.openDetail = id => {
  openDetailId = id;
  const item = news.find(n=>n.id===id);
  if (!item) return;
  const st=STATUS[item.status]||STATUS.waiting;
  const today=isToday(item.publishDate), tmrw=isTomorrow(item.publishDate);
  const dc=today?"#F59E0B":tmrw?"#1A56DB":"var(--text)";
  const ds=today?" ‚Äî Bug√ºn!":tmrw?" ‚Äî Yarƒ±n":"";
  const ts = item.createdAt?.toDate ? item.createdAt.toDate().toLocaleString("tr-TR") : "‚Äî";
  const locs = Array.isArray(item.locations) ? item.locations : (item.location ? [item.location] : []);
  const docs = Array.isArray(item.doctors) ? item.doctors : (item.doctor ? [item.doctor] : []);
  document.getElementById("detail-actions").innerHTML =
    `<button class="btn btn-ghost" onclick="openEditModal('${id}')">‚úèÔ∏è D√ºzenle</button>
     ${item.status!=="published"?`<button class="btn btn-success" onclick="publishItem('${id}')">‚úÖ Yayƒ±nla</button>`:""}
     <button class="btn btn-danger" onclick="confirmDelete('${id}')">üóë</button>`;
  document.getElementById("detail-body").innerHTML = `
    <div class="detail-status-bar" style="border-left-color:${st.color}">
      <div class="detail-chips">
        <span class="status-badge" style="color:${st.color};background:${st.bg};border-color:${st.border};font-size:13px">
          <span class="status-dot" style="background:${st.color}"></span>${st.label}
        </span>
        ${item.priority?`<span style="background:var(--amber-bg);color:#D97706;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700;border:1.5px solid var(--amber-border)">‚≠ê √ñNCELƒ∞KLƒ∞</span>`:""}
      </div>
      <div class="detail-main-title">${escapeHtml(item.title)||"Ba≈ülƒ±ksƒ±z"}</div>
      ${item.topic?`<div style="margin-top:6px"><span style="font-size:11px;font-weight:700;color:var(--text-soft)">B√ñL√úM</span> <span style="color:var(--text-soft)">¬∑</span> <span style="font-weight:600;color:var(--text-mid)">${escapeHtml(item.topic)}</span></div>`:""}
    </div>
    <div class="detail-grid">
      <div class="detail-field" style="${locs.length>1?'grid-column:1/-1':''}"><div class="detail-field-lbl">üìç LOKASYONLAR</div><div class="detail-field-val">${locs.map(escapeHtml).join(", ")||"‚Äî"}</div></div>
      <div class="detail-field" style="${docs.length>1?'grid-column:1/-1':''}"><div class="detail-field-lbl">üë®‚Äç‚öïÔ∏è DOKTORLAR</div><div class="detail-field-val">${docs.map(escapeHtml).join(", ")||"‚Äî"}</div></div>
      <div class="detail-field"><div class="detail-field-lbl">üé¨ √áEKƒ∞M TARƒ∞Hƒ∞</div><div class="detail-field-val">${fmtDate(item.shootDate)}</div></div>
      <div class="detail-field"><div class="detail-field-lbl">üì§ PAYLA≈ûIM TARƒ∞Hƒ∞</div><div class="detail-field-val" style="color:${dc}">${fmtDate(item.publishDate)}${ds}</div></div>
    </div>
    ${item.link?`<div style="background:var(--blue-bg);border:1.5px solid var(--blue-border);border-radius:11px;padding:13px 15px;margin-bottom:12px">
      <div style="font-size:10px;font-weight:700;color:var(--blue);letter-spacing:0.5px;margin-bottom:6px">üîó HABER Lƒ∞NKƒ∞</div>
      <a href="${escapeHtml(item.link)}" target="_blank" rel="noopener" style="font-size:13px;color:var(--blue);word-break:break-all;text-decoration:none;font-weight:600">${escapeHtml(item.link)}</a>
    </div>`:""}
    ${item.notes?`<div class="notes-box"><div class="notes-lbl">üìù NOTLAR</div><div class="notes-val">${escapeHtml(item.notes)}</div></div>`:""}
    <div class="detail-meta">
      ${item.createdBy?`Olu≈üturan: <strong>${escapeHtml(item.createdBy)}</strong> ¬∑ `:""}${ts}
      ${item.updatedBy && item.updatedBy !== item.createdBy?`<br>G√ºncelleyen: <strong>${escapeHtml(item.updatedBy)}</strong>`:""}
    </div>`;
  document.getElementById("detail-modal").style.display = "flex";
};

window.confirmDelete = id => {
  closeModal("detail-modal");
  document.getElementById("confirm-delete-btn").onclick = () => deleteItem(id);
  document.getElementById("delete-modal").style.display = "flex";
};

// FORM
window.openAddModal = () => {
  editingId = null;
  document.getElementById("modal-title").textContent = "Yeni Haber Ekle";
  document.getElementById("submit-btn").textContent  = "‚úÖ Kaydet";
  resetForm();
  document.getElementById("form-modal").style.display = "flex";
};
window.openEditModal = id => {
  const item = news.find(n=>n.id===id);
  if (!item) return;
  editingId = id;
  closeModal("detail-modal");
  document.getElementById("modal-title").textContent = "Haberi D√ºzenle";
  document.getElementById("submit-btn").textContent  = "üíæ G√ºncelle";
  fillForm(item);
  document.getElementById("form-modal").style.display = "flex";
};
function resetForm() {
  ["f-topic","f-title","f-shoot-date","f-publish-date","f-link","f-notes","f-custom-topic"]
    .forEach(id => { const el=document.getElementById(id); if(el) el.value=""; });
  document.getElementById("f-status").value = "waiting";
  document.getElementById("f-priority").checked = false;
  document.getElementById("custom-topic-wrap").style.display = "none";
  
  // Reset multi-inputs to single row
  document.getElementById("locations-container").innerHTML = `
    <div class="multi-input-row">
      <select class="form-control location-input"><option value="">Se√ßiniz‚Ä¶</option>${LOCATIONS.map(l=>`<option value="${l}">${l}</option>`).join("")}</select>
      <button type="button" class="btn btn-icon btn-add" onclick="addLocationRow()">+</button>
    </div>`;
  document.getElementById("doctors-container").innerHTML = `
    <div class="multi-input-row">
      <input class="form-control doctor-input" placeholder="Prof. Dr. Ad Soyad‚Ä¶" />
      <button type="button" class="btn btn-icon btn-add" onclick="addDoctorRow()">+</button>
    </div>`;
}
function fillForm(item) {
  document.getElementById("f-title").value        = item.title       ||"";
  document.getElementById("f-shoot-date").value   = item.shootDate   ||"";
  document.getElementById("f-publish-date").value = item.publishDate ||"";
  document.getElementById("f-link").value         = item.link        ||"";
  document.getElementById("f-status").value       = item.status      ||"waiting";
  document.getElementById("f-notes").value        = item.notes       ||"";
  document.getElementById("f-priority").checked   = !!item.priority;
  const known = TOPICS.includes(item.topic);
  document.getElementById("f-topic").value        = known ? item.topic : (item.topic?"Diƒüer":"");
  document.getElementById("f-custom-topic").value = known ? "" : (item.topic||"");
  document.getElementById("custom-topic-wrap").style.display = (!known&&item.topic)?"block":"none";
  
  // Fill locations
  const locs = Array.isArray(item.locations) ? item.locations : (item.location ? [item.location] : []);
  const locContainer = document.getElementById("locations-container");
  locContainer.innerHTML = "";
  if (locs.length === 0) locs.push("");
  locs.forEach((loc, i) => {
    const row = document.createElement("div");
    row.className = "multi-input-row";
    row.innerHTML = `
      <select class="form-control location-input"><option value="">Se√ßiniz‚Ä¶</option>${LOCATIONS.map(l=>`<option value="${l}" ${l===loc?"selected":""}>${l}</option>`).join("")}</select>
      <button type="button" class="btn btn-icon ${i===0?"btn-add":"btn-remove"}" onclick="${i===0?"addLocationRow()":"this.parentElement.remove()"}">${i===0?"+":"‚àí"}</button>`;
    locContainer.appendChild(row);
  });
  
  // Fill doctors
  const docs = Array.isArray(item.doctors) ? item.doctors : (item.doctor ? [item.doctor] : []);
  const docContainer = document.getElementById("doctors-container");
  docContainer.innerHTML = "";
  if (docs.length === 0) docs.push("");
  docs.forEach((doc, i) => {
    const row = document.createElement("div");
    row.className = "multi-input-row";
    row.innerHTML = `
      <input class="form-control doctor-input" placeholder="Prof. Dr. Ad Soyad‚Ä¶" value="${doc||''}" />
      <button type="button" class="btn btn-icon ${i===0?"btn-add":"btn-remove"}" onclick="${i===0?"addDoctorRow()":"this.parentElement.remove()"}">${i===0?"+":"‚àí"}</button>`;
    docContainer.appendChild(row);
  });
}
window.handleTopicChange = () => {
  document.getElementById("custom-topic-wrap").style.display =
    document.getElementById("f-topic").value==="Diƒüer"?"block":"none";
};
window.autoStatus = () => {
  const pd=document.getElementById("f-publish-date").value, st=document.getElementById("f-status");
  if (pd&&st.value==="waiting") st.value="scheduled";
};
window.handleSubmit = async () => {
  // Collect locations
  const locations = Array.from(document.querySelectorAll(".location-input")).map(s => s.value).filter(Boolean);
  // Collect doctors
  const doctors = Array.from(document.querySelectorAll(".doctor-input")).map(i => i.value.trim()).filter(Boolean);
  
  const title = document.getElementById("f-title").value.trim();
  const shoot = document.getElementById("f-shoot-date").value;
  
  if (locations.length === 0 || doctors.length === 0 || !title || !shoot) {
    showToast("En az 1 lokasyon, 1 doktor, ba≈ülƒ±k ve √ßekim tarihi zorunludur.","error");
    return;
  }
  
  const topicRaw = document.getElementById("f-topic").value;
  const topic = topicRaw==="Diƒüer" ? document.getElementById("f-custom-topic").value.trim() : topicRaw;
  
  const data = {
    locations, doctors, title, topic,
    shootDate:   document.getElementById("f-shoot-date").value,
    publishDate: document.getElementById("f-publish-date").value,
    link:        document.getElementById("f-link").value.trim(),
    status:      document.getElementById("f-status").value,
    notes:       document.getElementById("f-notes").value.trim(),
    priority:    document.getElementById("f-priority").checked,
    // Keep legacy fields for compatibility
    location: locations[0] || "",
    doctor:   doctors[0]   || "",
  };
  
  const btn=document.getElementById("submit-btn");
  btn.disabled=true; btn.textContent="Kaydediliyor‚Ä¶";
  try {
    if (editingId) { await updateNews(editingId,data); showToast("Haber g√ºncellendi."); }
    else           { await addNews(data);              showToast("Haber eklendi!"); }
    closeModal("form-modal");
  } catch(e) { showToast("Hata: "+e.message,"error"); }
  btn.disabled=false; btn.textContent=editingId?"üíæ G√ºncelle":"‚úÖ Kaydet";
};

window.closeModal = id => {
  document.getElementById(id).style.display="none";
  if (id==="detail-modal") openDetailId=null;
};
window.handleOverlayClick = e => {
  if (e.target===e.currentTarget) { e.currentTarget.style.display="none"; if(e.currentTarget.id==="detail-modal") openDetailId=null; }
};

// TAB SWITCHING
window.switchTab = tab => {
  document.getElementById("view-haberler").style.display = tab==="haberler" ? "block" : "none";
  document.getElementById("view-rapor").style.display    = tab==="rapor"    ? "block" : "none";
  document.getElementById("tab-haberler").classList.toggle("active", tab==="haberler");
  document.getElementById("tab-rapor").classList.toggle("active",    tab==="rapor");
  document.getElementById("btn-haber-ekle").style.display = tab==="haberler" ? "" : "none";
  if (tab==="rapor") renderReport();
};

// EXPORT REPORT
window.exportReport = () => {
  const period = document.getElementById("period-select").value;
  const published = news.filter(n => {
    if (n.status !== "published") return false;
    if (period === "all") return true;
    const d = n.publishDate;
    if (!d) return false;
    const now = new Date(), pd = new Date(d);
    if (period === "thismonth")  return pd.getMonth()===now.getMonth() && pd.getFullYear()===now.getFullYear();
    if (period === "lastmonth") { const lm=new Date(now.getFullYear(),now.getMonth()-1,1); return pd.getMonth()===lm.getMonth()&&pd.getFullYear()===lm.getFullYear(); }
    if (period === "thisyear")   return pd.getFullYear()===now.getFullYear();
    return true;
  });

  // Prepare CSV data
  const headers = ["Ba≈ülƒ±k", "Lokasyonlar", "Doktorlar", "B√∂l√ºm", "√áekim Tarihi", "Payla≈üƒ±m Tarihi", "Durum", "Link", "Notlar"];
  const rows = published.map(n => {
    const locs = Array.isArray(n.locations) ? n.locations.join("; ") : (n.location || "");
    const docs = Array.isArray(n.doctors) ? n.doctors.join("; ") : (n.doctor || "");
    return [
      n.title || "",
      locs,
      docs,
      n.topic || "",
      fmtDate(n.shootDate),
      fmtDate(n.publishDate),
      STATUS[n.status]?.label || n.status,
      n.link || "",
      (n.notes || "").replace(/"/g, '""')
    ];
  });

  // Create CSV
  const csvContent = [
    headers.map(h => `"${h}"`).join(","),
    ...rows.map(row => row.map(cell => `"${cell}"`).join(","))
  ].join("\n");

  // Add BOM for Excel UTF-8 support
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  const periodLabel = {all:"Tum-Zamanlar",thismonth:"Bu-Ay",lastmonth:"Gecen-Ay",thisyear:"Bu-Yil"}[period] || period;
  link.download = `Haber-Raporu-${periodLabel}-${new Date().toISOString().split("T")[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url);
  showToast("Rapor indirildi!", "success");
};

// REPORT
window.renderReport = () => {
  const period = document.getElementById("period-select").value;
  const published = news.filter(n => {
    if (n.status !== "published") return false;
    if (period === "all") return true;
    const d = n.publishDate;
    if (!d) return false;
    const now = new Date(), pd = new Date(d);
    if (period === "thismonth")  return pd.getMonth()===now.getMonth() && pd.getFullYear()===now.getFullYear();
    if (period === "lastmonth") { const lm=new Date(now.getFullYear(),now.getMonth()-1,1); return pd.getMonth()===lm.getMonth()&&pd.getFullYear()===lm.getFullYear(); }
    if (period === "thisyear")   return pd.getFullYear()===now.getFullYear();
    return true;
  });

  // Lokasyon bazlƒ± sayƒ±m
  const locMap = {};
  LOCATIONS.forEach(l => locMap[l] = 0);
  published.forEach(n => { if (n.location && locMap[n.location] !== undefined) locMap[n.location]++; });
  const maxLoc = Math.max(...Object.values(locMap), 1);

  // B√∂l√ºm bazlƒ± sayƒ±m
  const topicMap = {};
  published.forEach(n => { if (n.topic) topicMap[n.topic] = (topicMap[n.topic]||0)+1; });
  const topicRanked = Object.entries(topicMap).sort((a,b)=>b[1]-a[1]).slice(0,8);

  // Doktor bazlƒ± sayƒ±m
  const docMap = {};
  published.forEach(n => { if (n.doctor) docMap[n.doctor] = (docMap[n.doctor]||0)+1; });
  const docRanked = Object.entries(docMap).sort((a,b)=>b[1]-a[1]).slice(0,8);

  const COLORS = ["#10B981","#1A56DB","#F59E0B","#8B5CF6","#EF4444","#06B6D4","#EC4899","#84CC16"];

  document.getElementById("report-content").innerHTML = `
    <!-- √ñzet Stat Kartlarƒ± -->
    <div class="stats" style="margin-bottom:20px">
      <div class="stat-card" style="border-left:4px solid var(--green)">
        <div style="font-size:20px;margin-bottom:4px">üü¢</div>
        <div class="stat-num" style="color:var(--green)">${published.length}</div>
        <div class="stat-lbl">Payla≈üƒ±lan Haber</div>
      </div>
      <div class="stat-card" style="border-left:4px solid var(--blue)">
        <div style="font-size:20px;margin-bottom:4px">üìç</div>
        <div class="stat-num" style="color:var(--blue)">${Object.values(locMap).filter(v=>v>0).length}</div>
        <div class="stat-lbl">Aktif Lokasyon</div>
      </div>
      <div class="stat-card" style="border-left:4px solid var(--purple)">
        <div style="font-size:20px;margin-bottom:4px">üë®‚Äç‚öïÔ∏è</div>
        <div class="stat-num" style="color:var(--purple)">${Object.keys(docMap).length}</div>
        <div class="stat-lbl">Farklƒ± Doktor</div>
      </div>
      <div class="stat-card" style="border-left:4px solid var(--amber)">
        <div style="font-size:20px;margin-bottom:4px">üìÇ</div>
        <div class="stat-num" style="color:var(--amber)">${Object.keys(topicMap).length}</div>
        <div class="stat-lbl">Farklƒ± B√∂l√ºm</div>
      </div>
    </div>

    <!-- Lokasyon Bar Chart -->
    <div class="total-report-bar">
      <div class="report-card-title">üìç LOKASYON BAZINDA PAYLA≈ûILAN HABER SAYISI</div>
      ${LOCATIONS.map(l => {
        const count = locMap[l]||0;
        const pct   = count ? Math.round((count/maxLoc)*100) : 0;
        return `<div class="total-bar-row">
          <div class="total-bar-label">${l}</div>
          <div class="total-bar-track"><div class="total-bar-fill" style="width:${pct}%;background:${count?'var(--green)':'var(--border)'}"></div></div>
          <div class="total-bar-num" style="color:${count?'var(--green)':'var(--text-soft)'}">${count}</div>
        </div>`;
      }).join("")}
    </div>

    <!-- B√∂l√ºm ve Doktor Sƒ±ralamasƒ± -->
    <div class="report-two-col">
      <div class="summary-card">
        <div class="report-card-title">üìÇ EN √áOK PAYLA≈ûILAN B√ñL√úMLER</div>
        ${topicRanked.length ? topicRanked.map(([name,count],i)=>`
          <div class="rank-row">
            <span class="rank-num">${i+1}</span>
            <span style="width:9px;height:9px;border-radius:50%;background:${COLORS[i%COLORS.length]};flex-shrink:0;display:inline-block"></span>
            <span class="rank-name">${name}</span>
            <span class="rank-count" style="color:${COLORS[i%COLORS.length]}">${count}</span>
          </div>`).join("") :
          `<div style="color:var(--text-soft);font-size:13px;padding:12px 0;text-align:center">Veri yok</div>`}
      </div>
      <div class="summary-card">
        <div class="report-card-title">üë®‚Äç‚öïÔ∏è EN √áOK PAYLA≈ûAN DOKTORLAR</div>
        ${docRanked.length ? docRanked.map(([name,count],i)=>`
          <div class="rank-row">
            <span class="rank-num">${i+1}</span>
            <span class="rank-name">${name}</span>
            <span class="rank-count" style="color:var(--blue)">${count}</span>
          </div>`).join("") :
          `<div style="color:var(--text-soft);font-size:13px;padding:12px 0;text-align:center">Veri yok</div>`}
      </div>
    </div>

    <!-- Lokasyon Detay Kartlarƒ± -->
    <div class="report-card-title" style="margin-bottom:12px">üìã LOKASYON DETAYLARI</div>
    <div class="loc-detail-grid">
      ${LOCATIONS.filter(l=>locMap[l]>0).map(l => {
        const locNews = published.filter(n=>n.location===l);
        const w  = news.filter(n=>n.location===l&&n.status==="waiting").length;
        const sc = news.filter(n=>n.location===l&&n.status==="scheduled").length;
        const p  = locNews.length;
        const total = w+sc+p||1;
        return `<div class="loc-detail-card">
          <div class="loc-detail-top">
            <div class="loc-detail-name">üìç ${l}</div>
            <div class="loc-detail-total">${p} payla≈üƒ±ldƒ±</div>
          </div>
          <div class="mini-bar-row">
            <div class="mini-bar-label">Payla≈üƒ±ldƒ±</div>
            <div class="mini-bar-track"><div class="mini-bar-fill" style="width:${Math.round(p/total*100)}%;background:var(--green)"></div></div>
            <div class="mini-bar-num" style="color:var(--green)">${p}</div>
          </div>
          <div class="mini-bar-row">
            <div class="mini-bar-label">Planlandƒ±</div>
            <div class="mini-bar-track"><div class="mini-bar-fill" style="width:${Math.round(sc/total*100)}%;background:var(--blue)"></div></div>
            <div class="mini-bar-num" style="color:var(--blue)">${sc}</div>
          </div>
          <div class="mini-bar-row">
            <div class="mini-bar-label">Bekleyen</div>
            <div class="mini-bar-track"><div class="mini-bar-fill" style="width:${Math.round(w/total*100)}%;background:var(--red)"></div></div>
            <div class="mini-bar-num" style="color:var(--red)">${w}</div>
          </div>
        </div>`;
      }).join("") || `<div style="color:var(--text-soft);font-size:14px;padding:32px;text-align:center;grid-column:1/-1">Bu d√∂nemde payla≈üƒ±lan haber yok.</div>`}
    </div>
  `;
};

function renderAll() { renderAlerts(); renderStats(); buildLocChips(); buildStatusChips(); renderList(); }

// INITIALIZE - Run after DOM and Firebase ready
setTimeout(() => {
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const loginName = document.getElementById("login-name");
  
  if (loginBtn) loginBtn.addEventListener("click", handleLogin);
  if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
  if (loginName) loginName.addEventListener("keypress", e => { if (e.key === "Enter") handleLogin(); });
  
  checkLocalAuth();
}, 100);

// Auth observer (onAuthStateChanged) handles initialization
</script>
</body>
</html>
